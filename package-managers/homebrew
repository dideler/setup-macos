#!/usr/bin/env bash -e

source utils.sh

if ! [[ $(command -v brew) ]]; then
  echo | bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

brew analytics off
brew update

brew bundle --force --verbose --no-lock --file=- <<-BUNDLE
  tap 'homebrew/services'
  tap 'heroku/brew'
  tap 'zph/homebrew-cervezas' # for pdftk

  brew 'airshare'
  brew 'argon2'
  brew 'autoconf'
  brew 'automake'
  brew 'awscli'
  brew 'bandwhich'
  brew 'bash'
  brew 'bat'
  brew 'brotli'
  brew 'cloc'
  brew 'cmake'
  brew 'cmatrix'
  brew 'colordiff'
  brew 'coreutils'
  brew 'csvkit'
  brew 'csvq'
  brew 'ctags'
  brew 'curl'
  brew 'curl-openssl'
  brew 'diff-pdf'
  brew 'diff-so-fancy'
  brew 'direnv'
  brew 'dog'
  brew 'dos2unix'
  brew 'duf'
  brew 'eva'
  brew 'exa'
  brew 'fd'
  brew 'fff'
  brew 'ffmpeg'
  brew 'findomain'
  brew 'findutils'
  brew 'fish'
  brew 'fzf'
  brew 'gawk'
  brew 'gettext'
  brew 'gh'
  brew 'gifsicle'
  brew 'git'
  brew 'git-filter-repo'
  brew 'git-lfs'
  brew 'gitleaks'
  brew 'gitui'
  brew 'glow'
  brew 'gnu-getopt'
  brew 'gnu-indent'
  brew 'gnu-sed'
  brew 'gnu-tar'
  brew 'gnu-time'
  brew 'gnu-units'
  brew 'gnu-which'
  brew 'gnupg'
  brew 'gnutls'
  brew 'go'
  brew 'gobject-introspection'
  brew 'grep'
  brew 'gzip'
  brew 'heroku'
  brew 'highlight'
  brew 'htop-osx'
  brew 'httpie'
  brew 'imagemagick'
  brew 'insect'
  brew 'java'
  brew 'jp2a'
  brew 'jpeg'
  brew 'jq'
  brew 'less'
  brew 'lzop'
  brew 'make'
  brew 'mkcert'
  brew 'monolith'
  brew 'moreutils'
  brew 'mosh'
  brew 'ncdu'
  brew 'neovim'
  brew 'openssl'
  brew 'pandoc'
  brew 'pdftk'
  brew 'pgcli'
  brew 'pngquant'
  brew 'poppler'
  brew 'postgresql'
  brew 'python3'
  brew 'qpdf'
  brew 'rar'
  brew 'readline'
  brew 'redis'
  brew 'rename'
  brew 'ripgrep'
  brew 'ripgrep-all'
  brew 'rm-improved'
  brew 'rsync'
  brew 'screen'
  brew 'shellcheck'
  brew 'the_silver_searcher'
  brew 'tldr'
  brew 'trash'
  brew 'tree'
  brew 'unzip'
  brew 'vim'
  brew 'vips'
  brew 'watch'
  brew 'watchexec' # Also see https://github.com/dideler/watcher
  brew 'wget'
  brew 'youtube-dl'
  brew 'yq'

  cask '1password'
  cask 'aerial'
  cask 'alfred'
  cask 'atom'
  cask 'avibrazil-rdm'
  cask 'balenaetcher'
  cask 'brave-browser'
  cask 'caffeine'
  cask 'cloudflare-warp'
  cask 'copyq'
  cask 'dash'
  cask 'devdocs'
  cask 'docker'
  cask 'dropbox'
  cask 'fig'
  cask 'finicky'
  cask 'firefox'
  cask 'flux'
  cask 'flycut'
  cask 'github'
  cask 'google-chrome'
  cask 'google-drive'
  cask 'google-earth-pro'
  cask 'hiddenbar'
  cask 'iina'
  cask 'imageoptim'
  cask 'insomnia'
  cask 'iterm2'
  cask 'kap'
  cask 'keybase'
  cask 'lepton'
  cask 'ngrok'
  cask 'obsidian'
  cask 'osquery'
  cask 'paw'
  cask 'pgadmin4'
  cask 'physics-101' # SIZ9NKLYAS
  cask 'postico'
  cask 'postman'
  cask 'raycast'
  cask 'rectangle'
  cask 'rowanj-gitx'
  cask 'skype'
  cask 'slack'
  cask 'spotify'
  cask 'telegram'
  cask 'visual-studio-code'
  cask 'whatsapp'
  cask 'xquartz'
  # cask 'little-snitch'
  # cask 'mactex' # mactex is a very big all-in-one solution; consider basictex
  # cask 'sonic-robo-blast-2'
  # cask 'sonic-robo-blast-2-kart'
  # cask 'spectacle' # replaced by rectangle
  # cask 'vlc'

  mas 'Discovery', id: 1381004916
BUNDLE

# Use GNU commands without "g" prefix.

grep -q "gnubin" ~/.bash_profile || \
  echo 'export PATH="/usr/local/opt/coreutils/libexec/gnubin:$PATH"' >> ~/.bash_profile

grep -q "gnubin" ~/.zshrc || \
  echo 'export PATH="/usr/local/opt/coreutils/libexec/gnubin:$PATH"' >> ~/.zshrc

if is_available fish && echo "$PATH" | grep -qv "gnubin"; then
  fish -c 'set --universal fish_user_paths /usr/local/opt/coreutils/libexec/gnubin $fish_user_paths'
  fish -c 'set --universal fish_user_paths /opt/homebrew/bin/ $fish_user_paths'
fi

log_info "Installed homebrew and packages."
